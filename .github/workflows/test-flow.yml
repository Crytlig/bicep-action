name: TestToken

on:
  push:
    branches:
      - main
  workflow_dispatch:
  
permissions:
  id-token: write
  contents: read


jobs:
  job:
    runs-on: ubuntu-latest
    
    steps:
      
    - name: Az CLI login
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.CLIENT_ID }}
        tenant-id: ${{ secrets.TENANT_ID }}
        subscription-id: ${{ secrets.SUBSCRIPTION_ID }}
        
    - name: Get Environment variables
      run: printenv

    - name: print ACTIONS_ID_TOKEN_REQUEST_URL
      run: echo ${ACTIONS_ID_TOKEN_REQUEST_URL}

    - name: Debugging with ssh
      uses: lhotari/action-upterm@v1


    - name:  JWT
      run: | 
        bearerToken=${ACTIONS_ID_TOKEN_REQUEST_TOKEN}
        runtimeUrl=${ACTIONS_ID_TOKEN_REQUEST_URL}
        runtimeUrl="${runtimeUrl}&audience=api://AzureADTokenExchange"
        JWT=$(curl -H "Authorization: bearer $bearerToken" $runtimeUrl | jq -r ".value")
        echo $JWT